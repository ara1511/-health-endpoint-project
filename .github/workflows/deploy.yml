name: Deploy - Health Endpoint Service

# Ejecutar solo en push a main
on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permitir ejecuciÃ³n manual

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: []  # Agregar dependencia del CI si existe
    
    # Solo ejecutar si los tests pasaron
    if: github.ref == 'refs/heads/main'
    
    steps:
    # Checkout del cÃ³digo
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    # Configurar Node.js
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # Instalar dependencias
    - name: ğŸ“¦ Install dependencies
      run: npm ci --only=production
    
    # Build Docker image
    - name: ğŸ³ Build Docker image
      run: |
        docker build -t health-endpoint:latest .
        docker tag health-endpoint:latest health-endpoint:${{ github.sha }}
    
    # Test de deployment local
    - name: ğŸ§ª Test deployment
      run: |
        # Ejecutar contenedor
        docker run -d -p 3000:3000 --name health-test health-endpoint:latest
        
        # Esperar que estÃ© listo
        sleep 10
        
        # Test del health check
        response=$(curl -s http://localhost:3000/health)
        if echo "$response" | grep -q '"status":"ok"'; then
          echo "âœ… Deployment test passed!"
        else
          echo "âŒ Deployment test failed!"
          exit 1
        fi
        
        # Limpiar
        docker stop health-test
        docker rm health-test
    
    # AquÃ­ puedes agregar deployment real a tu plataforma
    # Ejemplos comentados:
    
    # Deploy to Heroku
    # - name: ğŸš€ Deploy to Heroku
    #   uses: akhileshns/heroku-deploy@v3.12.12
    #   with:
    #     heroku_api_key: ${{secrets.HEROKU_API_KEY}}
    #     heroku_app_name: "your-health-endpoint-app"
    #     heroku_email: "your-email@example.com"
    
    # Deploy to AWS ECS
    # - name: ğŸš€ Deploy to AWS ECS
    #   uses: aws-actions/amazon-ecs-deploy-task-definition@v1
    #   with:
    #     task-definition: task-definition.json
    #     service: health-endpoint-service
    #     cluster: production-cluster
    
    - name: âœ… Deployment completed
      run: echo "ğŸ‰ Health endpoint deployed successfully!"